<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Backup and restore workflows - Opencast Moodle Plugins Documentation</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../css/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Configuration of the Duplicate Workflow", url: "#_top", children: [
              {title: "Own workflows", url: "#own-workflows" },
              {title: "Important changes", url: "#important-changes" },
              {title: "Workflow examples", url: "#workflow-examples" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../global_overview/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../global_overview/" class="btn btn-xs btn-link">
        Global overview
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../additional_features/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../additional_features/" class="btn btn-xs btn-link">
        Additional features
      </a>
    </div>
    
  </div>

    

    <h1 id="configuration-of-the-duplicate-workflow">Configuration of the Duplicate Workflow</h1>
<p>To use the backup and restore functionality, you need to specify a duplication workflow within the Moodle settings. However, there is no out of the box workflow defined in Opencast, which allows, to duplicate a series.</p>
<h2 id="own-workflows">Own workflows</h2>
<p>If you want to create your own workflow, here are the descriptions of the general restore process:</p>
<p>In the restore process, we first create a new opencast series for the new course. Afterwards, for each event UID of the
backup a 'duplicate' workflow is started, while the new series UID is given as a configuration parameter to the start workflow call. The variable, used to store the series ID, is 'seriesId'.
In our workflow definition example from above, the first workflow <em>lms-automated-duplicate</em> will duplicate the event and will start a new workflow for the new event. This second workflow <em>lms-publish-duplicate</em> then assigns the series of the new course to the new event.</p>
<p>In order to be able to select your duplicate workflow within Moodle, you need to assign the <em>'api'</em> tag to it, since the viable duplicate workflows are filtered by that.</p>
<h2 id="important-changes">Important changes</h2>
<p>Prior to version v4.1-r1 of the plugin, the following workflows must use "seriesID" instead of "seriesId". It is highly recommended/necessary to update these variables from "seriesID" to "seriesId" in your workflows if you are planing to use this feature with the latest version of the plugin.</p>
<h4 id="important-opencast-database-change">Important Opencast database change</h4>
<p>In addition to the steps above, if the above mentioned issue is applied to your system, then you might encounter the issue of unsuccessful duplication for old videos when using the new workflows with "seriesId", for that to be fixed, you have to manually perform the following SQL database queries against your Opencast database:</p>
<ol>
<li>To make sure that "oc_assets_properties" table has any record of "seriesID":</li>
</ol>
<p><code>SELECT * FROM oc_assets_properties where property_name='seriesID';</code></p>
<ol>
<li>If the above query indicates that "seriesID" exists, you have to perform the following SQL query to delete it from the table:</li>
</ol>
<p><code>DELETE FROM oc_assets_properties WHERE property_name='seriesID';</code></p>
<h2 id="workflow-examples">Workflow examples</h2>
<p>The workflow that is triggered by Moodle:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;definition xmlns=&quot;http://workflow.opencastproject.org&quot;&gt;

  &lt;id&gt;lms-automated-duplicate&lt;/id&gt;
  &lt;title&gt;LMS Upload aus dem LMS duplizieren&lt;/title&gt;
  &lt;tags&gt;
    &lt;tag&gt;api&lt;/tag&gt;
  &lt;/tags&gt;

  &lt;operations&gt;

    &lt;!-- Create the new events --&gt;
    &lt;operation
      id=&quot;duplicate-event&quot;
      fail-on-error=&quot;true&quot;
      exception-handler-workflow=&quot;partial-error&quot;
      description=&quot;Duplicate Event&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;source-flavors&quot;&gt;*/source,*/prepared,*/search+preview,dublincore/*,*/player+preview,*/feed+preview,*/timeline+preview,smil/*,security/xacml+series&lt;/configuration&gt;
        &lt;configuration key=&quot;number-of-events&quot;&gt;1&lt;/configuration&gt;
        &lt;configuration key=&quot;target-tags&quot;&gt;+copied&lt;/configuration&gt;
        &lt;configuration key=&quot;property-namespaces&quot;&gt;org.opencastproject.assetmanager.security, org.opencastproject.workflow.configuration&lt;/configuration&gt;
        &lt;configuration key=&quot;copy-number-prefix&quot;&gt;Kopie&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

    &lt;!-- Start new workflow --&gt;
    &lt;operation
      id=&quot;start-workflow&quot;
      fail-on-error=&quot;true&quot;
      retry-strategy=&quot;hold&quot;
      max-attempts=&quot;5&quot;
      exception-handler-workflow=&quot;partial-error&quot;
      description=&quot;Start workflow on duplicate&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;workflow-definition&quot;&gt;lms-publish-duplicate&lt;/configuration&gt;
        &lt;configuration key=&quot;media-package&quot;&gt;${duplicate_media_package_1_id}&lt;/configuration&gt;
        &lt;configuration key=&quot;seriesId&quot;&gt;${seriesId}&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

    &lt;!-- Cleanup the working file repository --&gt;
    &lt;operation
      id=&quot;cleanup&quot;
      fail-on-error=&quot;false&quot;
      description=&quot;Remove temporary processing artifacts&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;preserve-flavors&quot;&gt;security/*&lt;/configuration&gt;
        &lt;configuration key=&quot;delete-external&quot;&gt;true&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

  &lt;/operations&gt;

&lt;/definition&gt;
</code></pre>
<p>The first workflow triggers this second workflow on the duplicated <em>mediapackage</em>.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;definition xmlns=&quot;http://workflow.opencastproject.org&quot;&gt;
  &lt;id&gt;lms-publish-duplicate&lt;/id&gt;
  &lt;title&gt;Publish a duplicate of an LMS upload&lt;/title&gt;

  &lt;operations&gt;

    &lt;!-- Apply the default workflow configuration --&gt;

    &lt;operation
      id=&quot;defaults&quot;
      description=&quot;Applying default configuration values&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;straightToPublishing&quot;&gt;true&lt;/configuration&gt;
        &lt;configuration key=&quot;flagForCutting&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;flagForReview&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;flagQuality360p&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;flagQuality480p&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;flagQuality720p&quot;&gt;true&lt;/configuration&gt;
        &lt;configuration key=&quot;flagQuality1080p&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;flagQuality2160p&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;publishToEngage&quot;&gt;true&lt;/configuration&gt;
        &lt;configuration key=&quot;publishToApi&quot;&gt;true&lt;/configuration&gt;
        &lt;configuration key=&quot;publishToOaiPmh&quot;&gt;true&lt;/configuration&gt;
        &lt;configuration key=&quot;publishToYouTube&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;publishToAws&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;uploadedSearchPreview&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;publishLive&quot;&gt;false&lt;/configuration&gt;
        &lt;configuration key=&quot;thumbnailType&quot;&gt;0&lt;/configuration&gt;
        &lt;configuration key=&quot;thumbnailPosition&quot;&gt;1&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;


    &lt;!-- Apply series --&gt;

    &lt;operation
      id=&quot;series&quot;
      exception-handler-workflow=&quot;partial-error&quot;
      description=&quot;Apply series metadata and acl&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;series&quot;&gt;${seriesId}&lt;/configuration&gt;
        &lt;configuration key=&quot;attach&quot;&gt;*/*&lt;/configuration&gt;
        &lt;configuration key=&quot;apply-acl&quot;&gt;true&lt;/configuration&gt;
        &lt;configuration key=&quot;copy-metadata&quot;&gt;isPartOf&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

    &lt;operation
      id=&quot;tag&quot;
      description=&quot;Tagging metadata catalogs for publication&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;source-flavors&quot;&gt;dublincore/*,security/*&lt;/configuration&gt;
        &lt;configuration key=&quot;target-tags&quot;&gt;+engage-download,+archive&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

    &lt;!-- Archive --&gt;

    &lt;operation
      id=&quot;snapshot&quot;
      description=&quot;Archive updated duplicate&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;source-tags&quot;&gt;archive&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

    &lt;!-- Encode and publish --&gt;

    &lt;operation
      id=&quot;include&quot;
      description=&quot;Publish the recording&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;workflow-id&quot;&gt;partial-publish&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

    &lt;!-- Archive after publish --&gt;

    &lt;operation
      id=&quot;snapshot&quot;
      description=&quot;Archive publish information&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;source-tags&quot;&gt;archive&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

    &lt;!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - --&gt;
    &lt;!-- Cleanup                                                           --&gt;
    &lt;!--                                                                   --&gt;
    &lt;!-- Remove work artifacts.                                            --&gt;
    &lt;!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - --&gt;

    &lt;!-- Clean the system from work artifacts --&gt;

    &lt;operation
      id=&quot;cleanup&quot;
      fail-on-error=&quot;false&quot;
      description=&quot;Remove temporary processing artifacts&quot;&gt;
      &lt;configurations&gt;
        &lt;configuration key=&quot;preserve-flavors&quot;&gt;security/*&lt;/configuration&gt;
        &lt;configuration key=&quot;delete-external&quot;&gt;true&lt;/configuration&gt;
      &lt;/configurations&gt;
    &lt;/operation&gt;

  &lt;/operations&gt;
&lt;/definition&gt;
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../global_overview/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../global_overview/" class="btn btn-xs btn-link">
        Global overview
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../additional_features/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../additional_features/" class="btn btn-xs btn-link">
        Additional features
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/Opencast-Moodle/documentation/edit/master/docs/block/backup_restore_workflows.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>